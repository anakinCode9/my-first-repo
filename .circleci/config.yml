version: 2.1

orbs:
  node: circleci/node@5

jobs:
  build-node:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Build project
          command: npm run build
      - run:
          name: Copy build artifacts
          command: |
            mkdir -p ~/artifacts
            cp -R build dist public .output .next .docusaurus ~/artifacts 2>/dev/null || true
      - persist_to_workspace:
          root: ~/artifacts
          paths:
            - .

  deploy:
    docker:
      - image: cimg/aws:2023.12
    steps:
      - checkout
      - attach_workspace:
          at: ~/artifacts
      - run:
          name: Assume role and deploy
          command: |
            sudo apt-get update && sudo apt-get install -y jq

            CREDS=$(aws sts assume-role \
              --role-arn arn:aws:iam::915920435036:role/circleci-deploy-role \
              --role-session-name circleci-session)

            export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r .Credentials.AccessKeyId)
            export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r .Credentials.SecretAccessKey)
            export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r .Credentials.SessionToken)

            aws s3 sync ~/artifacts s3://circleci-bucket-x/ --region eu-north-1 --delete

workflows:
  build-and-deploy:
    jobs:
      - build-node
      - deploy:
          requires:
            - build-node
