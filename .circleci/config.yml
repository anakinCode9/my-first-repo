version: 2.1

orbs:
  node: circleci/node@5

jobs:
  build-node:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Build project
          command: npm run build
      - run:
          name: Copy build artifacts
          command: |
            mkdir -p ~/artifacts
            cp -R out ~/artifacts
      - persist_to_workspace:
          root: ~/artifacts
          paths:
            - .

  deploy:
    docker:
      - image: cimg/aws:2023.12
    steps:
      - checkout
      - attach_workspace:
          at: ~/artifacts

      # ğŸ” Diagnoza AWS
      - run:
          name: Debug AWS Identity & S3 Buckets
          command: |
            echo "ğŸ“› Who am I?"
            aws sts get-caller-identity || echo "âŒ Failed to get identity"
            
            echo "ğŸ“‚ List all accessible buckets"
            aws s3 ls || echo "âŒ Failed to list buckets"
            
            echo "ğŸ“ Try listing your target bucket"
            aws s3 ls s3://df9089a0df9g/ --region eu-north-1 || echo "âŒ Bucket not accessible"

      # âœ… Deploy do S3
      - run:
          name: Deploy to S3
          command: |
            aws s3 sync ~/artifacts s3://df9089a0df9g/ --delete --region eu-north-1

workflows:
  build-and-deploy:
    jobs:
      - build-node
      - deploy:
          requires:
            - build-node
